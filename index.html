<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Mapbox GL JS map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            display: none;
            font: 12px/20px 'Basic Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            padding: 10px;
            position: absolute;
            right: 0;
            top: 0;
            width: 230px;
            overflow: hidden;
            white-space: normal;
             transition: opacity 0.3s ease;
        }

        .card-title {
            font-family: 'Basic Sans', serif;
            /* Example font */
            font-size: 30px;
            /* Larger font size */
            font-weight: bold;
            /* Bold text */
            color: #2a2a2a;
            /* Darker color */
            /* add other styles like text-transform, letter-spacing, etc. */
        }

        .map-overlay-inner {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 25vw;
            height: 96vh;
            font-family: 'Basic Sans', serif;
            font-size: 18px;
            line-height: 1.5;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .5);
            z-index: 9999;
            box-sizing: border-box;
             transition: height 0.2s ease;
    touch-action: none;
        }

        /* Responsive override for mobile screens */
        @media (max-width: 768px) {
            .map-overlay-inner {
                top: auto;
                /* unset top */
                bottom: 0;
                /* align to bottom */
                left: 0;
                overflow-y: auto;
                width: 100vw;
                /* full screen width */
                height: 50vh;
                /* bottom half */
                border-radius: 8px 8px 0 0;
                /* rounded top corners */
            }
        }

        .map-overlay-drag-handle {
            width: 60px;
            height: 6px;
            background: #ccc;
            border-radius: 3px;
            margin: 8px auto;
            touch-action: none;
    cursor: grab;
        }

        #method-filters {
            font-family: 'Basic Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: white;
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 10px;
            right: 50px;
            z-index: 1000;
            max-width: 100px;
            font-size: 16px;
        }

        #menu {
            position: absolute;
            background: #fff;
            padding: 10px;
            font-family: 'Open Sans', sans-serif;
            z-index: 1;
            top: 10px;
            right: 190px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .close-button {
    position: absolute;
    top: 10px;
    right: 15px;
    background: transparent;
    border: none;
    font-size: 24px;
    color: #333;
    cursor: pointer;
    z-index: 10000;
}
    </style>
</head>

<body>

    <div id="map"></div>
    <!-- The rest of your content -->

    <div id="menu">
        <input id="satellite-streets-v12" type="radio" name="rtoggle" value="satellite">
        <label for="satellite-streets-v12">Satellite</label>
        <input id="outdoors-v12" type="radio" name="rtoggle" value="outdoors" checked="checked">
        <label for="outdoors-v12">Outdoors</label>
    </div>

    <div id="method-filters">
        <strong>Filter waterway by method</strong><br>
        <label><input type="checkbox" value="fly" checked> Fly</label><br>
        <label><input type="checkbox" value="spin" checked> Spin</label><br>
        <label><input type="checkbox" value="bait" checked> Bait</label>
    </div>

    <div class="map-overlay" id="properties"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmVhdWNoaWxkIiwiYSI6ImNtYWxuZTh4cTBhbm4yam9wb2N6OTZmc2YifQ._fwiw77G_XhZonhV5d3CJA';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v12',
            center: [173.1, -41.4],
            zoom: 5
        });
        map.addControl(new mapboxgl.FullscreenControl());
        map.addControl(new mapboxgl.NavigationControl({
            showCompass: false
        }));
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true
        }));

        map.dragRotate.disable();


        // disable map rotation using touch rotation gesture
        map.touchZoomRotate.disableRotation();

        const card = document.getElementById('properties');

        const showCard = (feature) => {
    const props = feature.properties;
    const displayFields = {
        methods: 'Method',
        open: 'Open',
        limtrout: 'Trout Limit',
        Description: "Description",
    };

    let content = `
    <div class="map-overlay-inner">
        <div class="map-overlay-drag-handle"></div>
        <button class="close-button" onclick="document.getElementById('properties').style.display='none'">×</button>
        <code class="card-title">${props.name || props.Title || 'No Title'}</code>
        <hr>
        <ul>
    `;

    for (const [key, label] of Object.entries(displayFields)) {
        if (props[key] !== undefined) {
            content += `<li><b>${label}</b>: ${props[key]}</li>`;
        }
    }

    content += `</ul></div>`;
    card.innerHTML = content;
    card.style.display = 'block';
};


        let selectedAccess = null;
        let selectedRiver = null;
        let hoveredAccessPointId = null;
        let hoveredRiverId = null;
        let toggleIndex = 0; // 0 or 1, to switch between point and line
        // Before adding the layer, load and add your icon image:
        map.on('load', () => {
            // Load access icon
            map.loadImage('Picture5.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('access-icon')) {
                    map.addImage('access-icon', image);
                }
            });

            // Load clicked access icon
            map.loadImage('Revised-Dot-Clicked.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('access-icon-clicked')) {
                    map.addImage('access-icon-clicked', image);
                }
            });

            // Load hut icon
            map.loadImage('Hut-Marker-Dot.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('hut-icon')) {
                    map.addImage('hut-icon', image);
                }
            });

            // Now add all your layers AFTER the images are loaded
            addCustomDataAndLayers();
        });


        function addCustomDataAndLayers() {
            const layers = map.getStyle().layers;
            let firstSymbolId;
            for (const layer of layers) {
                if (layer.type === 'symbol') {
                    firstSymbolId = layer.id;
                    break;
                }
            }

            map.addSource('FG Regions', {
                type: 'geojson',
                data: 'FG regions.geojson'
            });

            map.addLayer({
                id: 'FG Regions-line',
                type: 'line',
                source: 'FG Regions',
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': 'grey',
                    'line-width': 4,
                    'line-opacity': 0.6
                }
            }, firstSymbolId);

            map.addSource('AW Rivers', {
                type: 'geojson',
                data: 'map.geojson',
                generateId: true
            });

            fetch('https://services1.arcgis.com/3JjYDyG3oajxU6HO/arcgis/rest/services/DOC_Campsites/FeatureServer/0/query?outFields=*&where=1=1&f=geojson')
                .then(response => response.json())
                .then(data => {
                    map.addSource('DOC Campsites', {
                        type: 'geojson',
                        data: data
                    });

                    // Now add the symbol layer using the icon
                    map.addLayer({
                        id: 'DOC Campsites',
                        type: 'symbol',
                        source: 'DOC Campsites',
                        minzoom: 8,
                        layout: {
                            'icon-image': 'hut-icon',
                            'icon-size': .15,
                            'icon-anchor': 'bottom',
                            'icon-allow-overlap': true
                        },
                        paint: {
                            // You can still style the icon with paint properties if needed,
                            // but circle-color and circle-radius don't apply here.
                        }
                    });
                });


            map.addLayer({
                id: 'AW Rivers-line',
                type: 'line',
                source: 'AW Rivers',
                minzoom: 7,
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': [
                        'case',
                        ['boolean', ['feature-state', 'selected'], false],
                        '#298096',
                        '#38afcd'
                    ],
                    'line-width': [
                        'case',
                        ['boolean', ['feature-state', 'selected'], false],
                        10,
                        ['boolean', ['feature-state', 'highlight'], false],
                        9,
                        6
                    ],
                    'line-opacity': .9
                }
            });

            map.addSource('AW Access', {
                type: 'geojson',
                data: 'Mapbox Access Test.geojson',
                generateId: true
            });


            map.addLayer({
                id: 'AW Access-points',
                type: 'symbol',
                source: 'AW Access',
                minzoom: 10,
                layout: {
                    'icon-image': [
                        'image',
                        'access-icon',
                    ],

                    'icon-size': .14,
                    'icon-anchor': 'center',
                    'icon-allow-overlap': true,
                },
            });

            let selectedFeatureId = null;
            let hoverFeatureId = null;

            function updateIconSize() {
                map.setLayoutProperty('AW Access-points', 'icon-size', [
                    'case',
                    // If hovered and not selected, use hover size
                    ['all',
                        ['==', ['id'], hoverFeatureId],
                        ['!=', ['id'], selectedFeatureId]
                    ], 0.15,
                    // If selected, use selected size
                    ['==', ['id'], selectedFeatureId], 0.18,
                    // Default size
                    0.14
                ]);
            }

            // Hover start — only update if not the selected feature
            map.on('mouseenter', 'AW Access-points', e => {
                map.getCanvas().style.cursor = 'pointer';

                const hoveredId = e.features[0].id;
                // Only apply hover if not currently selected
                if (hoveredId !== selectedFeatureId) {
                    hoverFeatureId = hoveredId;
                    updateIconSize();
                }
            });

            // Hover end — clear hover unless it's also selected
            map.on('mouseleave', 'AW Access-points', () => {
                map.getCanvas().style.cursor = '';
                hoverFeatureId = null;
                updateIconSize();
            });

            // Click on an access point — select it
            map.on('click', 'AW Access-points', e => {
                selectedFeatureId = e.features[0].id;
                hoverFeatureId = null; // Clear hover on selection
                updateIconSize();
            });

            // Click elsewhere — clear selection
            map.on('click', e => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['AW Access-points']
                });

                if (features.length === 0 && selectedFeatureId !== null) {
                    selectedFeatureId = null;
                    updateIconSize();
                }
            });

            map.on('click', (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: ['AW Access-points', 'AW Rivers-line']
                });

                // Deselect previous selection
                if (selectedAccess) {
                    map.setFeatureState({ source: 'AW Access', id: selectedAccess.id }, { selected: false });
                    selectedAccess = null;
                }
                if (selectedRiver) {
                    map.setFeatureState({ source: 'AW Rivers', id: selectedRiver.id }, { selected: false });
                    selectedRiver = null;
                }

                if (features.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                // Prioritize selecting points over lines
                const pointFeature = features.find(f => f.layer.id === 'AW Access-points');
                const lineFeature = features.find(f => f.layer.id === 'AW Rivers-line');

                if (pointFeature) {
                    selectedAccess = pointFeature;
                    map.setFeatureState({ source: 'AW Access', id: pointFeature.id }, { selected: true });
                    showCard(pointFeature);
                } else if (lineFeature) {
                    selectedRiver = lineFeature;
                    map.setFeatureState({ source: 'AW Rivers', id: lineFeature.id }, { selected: true });
                    showCard(lineFeature);
                }
            });

            map.on('mouseenter', 'AW Access-points', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const feature = e.features[0];

                if (hoveredRiverId !== null) {
                    map.setFeatureState({ source: 'AW Rivers', id: hoveredRiverId }, { highlight: false });
                    hoveredRiverId = null;
                }
                if (hoveredAccessPointId !== null && hoveredAccessPointId !== feature.id) {
                    map.setFeatureState({ source: 'AW Access', id: hoveredAccessPointId }, { highlight: false });
                }
                hoveredAccessPointId = feature.id;
                map.setFeatureState({ source: 'AW Access', id: feature.id }, { highlight: true });
            });

            map.on('mouseleave', 'AW Access-points', () => {
                map.getCanvas().style.cursor = '';
                if (hoveredAccessPointId !== null) {
                    map.setFeatureState({ source: 'AW Access', id: hoveredAccessPointId }, { highlight: false });
                    hoveredAccessPointId = null;
                }
            });

            map.on('mouseenter', 'AW Rivers-line', (e) => {
                map.getCanvas().style.cursor = 'pointer';
                const feature = e.features[0];

                if (hoveredAccessPointId !== null) {
                    map.setFeatureState({ source: 'AW Access', id: hoveredAccessPointId }, { highlight: false });
                    hoveredAccessPointId = null;
                }
                if (hoveredRiverId !== null && hoveredRiverId !== feature.id) {
                    map.setFeatureState({ source: 'AW Rivers', id: hoveredRiverId }, { highlight: false });
                }
                hoveredRiverId = feature.id;
                map.setFeatureState({ source: 'AW Rivers', id: feature.id }, { highlight: true });
            });

            map.on('mouseleave', 'AW Rivers-line', () => {
                map.getCanvas().style.cursor = '';
                if (hoveredRiverId !== null) {
                    map.setFeatureState({ source: 'AW Rivers', id: hoveredRiverId }, { highlight: false });
                    hoveredRiverId = null;
                }
            });
        }

        function updateRiverFilter() {
            const checked = Array.from(document.querySelectorAll('#method-filters input:checked'))
                .map(input => input.value.toLowerCase());

            if (map.getLayer('AW Rivers-line')) {
                if (checked.length === 0) {
                    // Hide all features if no filters are selected
                    map.setFilter('AW Rivers-line', ['==', 'fly', -1]);
                } else {
                    const filter = ['any', ...checked.map(method => ['==', ['get', method], 1])];
                    map.setFilter('AW Rivers-line', filter);
                }
            }
        }



        // Add event listeners to checkboxes
        document.querySelectorAll('#method-filters input').forEach(input => {
            input.addEventListener('change', updateRiverFilter);
        });

        // Call it once to set initial filter
        map.on('load', () => {
            updateRiverFilter();
        });
        map.on('load', () => {
            map.addControl(new mapboxgl.FullscreenControl({ container: document.querySelector('body') }));
            map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true,
                showUserHeading: true
            }));
            addCustomDataAndLayers();
        });
        const layerList = document.getElementById('menu');
        const inputs = layerList.getElementsByTagName('input');

        for (const input of inputs) {
            input.onclick = (layer) => {
                const styleId = `mapbox://styles/mapbox/${layer.target.id}`;
                map.setStyle(styleId);
            };
        }

        // Re-add custom data and images after each style change
        map.on('style.load', () => {
            map.loadImage('Picture5.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('access-icon')) map.addImage('access-icon', image);
            });

            map.loadImage('Revised-Dot-Clicked.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('access-icon-clicked')) map.addImage('access-icon-clicked', image);
            });

            map.loadImage('Hut-Marker-Dot.png', (error, image) => {
                if (error) throw error;
                if (!map.hasImage('hut-icon')) map.addImage('hut-icon', image);
            });

            // Re-add your sources and layers
            addCustomDataAndLayers();
        });



        (function enableResizing() {
    let startY = 0;
    let startHeight = 0;
    const card = document.getElementById('properties');

    document.addEventListener('mousedown', startDrag);
    document.addEventListener('touchstart', startDrag, { passive: false });

    function startDrag(e) {
        const target = e.target.closest('.map-overlay-drag-handle');
        if (!target) return;

        e.preventDefault();
        startY = e.touches ? e.touches[0].clientY : e.clientY;

        const overlay = target.closest('.map-overlay-inner');
        startHeight = overlay.offsetHeight;

        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag, { passive: false });

        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }

    function onDrag(e) {
        e.preventDefault();
        const currentY = e.touches ? e.touches[0].clientY : e.clientY;
        const deltaY = startY - currentY;

        const overlay = document.querySelector('.map-overlay-inner');
        let newHeight = startHeight + deltaY;

        // Clamp the height between 30% and 90% of viewport height
        const minHeight = window.innerHeight * 0.3;
        const maxHeight = window.innerHeight * 0.9;
        newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

        overlay.style.height = `${newHeight}px`;
    }

    function stopDrag() {
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('touchmove', onDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchend', stopDrag);
    }
})();

    </script>

</body>

</html>